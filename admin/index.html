<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MD Exotic Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Decap CMS -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Netlify Identity widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <div id="nc-root"></div>

    <script>
      // Стартираме CMS след като DOM е готов
      document.addEventListener('DOMContentLoaded', function () {
        if (window.CMS) CMS.init({ config: { load_config_file: true } });
      });

      // Предпазител срещу безкрайно презареждане
      (function () {
        if (!window.netlifyIdentity) return;

        // Ако user е вече логнат при init – не правим redirect (оставяме CMS да зареди)
        window.netlifyIdentity.on('init', (user) => {
          // по желание: console.log('init user?', !!user);
        });

        // При току-що успешен login – еднократно връщаме към /admin/, после спираме
        window.netlifyIdentity.on('login', () => {
          if (!sessionStorage.getItem('cmsLoggedOnce')) {
            sessionStorage.setItem('cmsLoggedOnce', '1');
            // replace вместо href за да не правим доп. история
            window.location.replace('/admin/');
          }
        });

        // При logout – чистим флага
        window.netlifyIdentity.on('logout', () => {
          sessionStorage.removeItem('cmsLoggedOnce');
        });
      })();
    </script>
  </body>
</html>
